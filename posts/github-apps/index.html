<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Demystifying GitHub Apps: Using GitHub Apps to Replace Service Accounts" /><meta name="author" content="Josh Johanning" /><meta property="og:locale" content="en" /><meta name="description" content="Creating no-code GitHub Apps to install to an organization to replace having to create service accounts or a user PAT for authorization in GitHub Actions" /><meta property="og:description" content="Creating no-code GitHub Apps to install to an organization to replace having to create service accounts or a user PAT for authorization in GitHub Actions" /><link rel="canonical" href="https://josh-ops.com/posts/github-apps/" /><meta property="og:url" content="https://josh-ops.com/posts/github-apps/" /><meta property="og:site_name" content="josh-ops" /><meta property="og:image" content="https://josh-ops.com/github-apps.png" /><meta property="og:image:height" content="100%" /><meta property="og:image:width" content="100%" /><meta property="og:image:alt" content="An example GitHub App" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-07T20:00:00-06:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://josh-ops.com/github-apps.png" /><meta name="twitter:image:alt" content="An example GitHub App" /><meta property="twitter:title" content="Demystifying GitHub Apps: Using GitHub Apps to Replace Service Accounts" /><meta name="twitter:site" content="@jjjettrain" /><meta name="twitter:creator" content="@Josh Johanning" /><meta name="google-site-verification" content="google-site-verification=eTIC71VhPBtwll8rNv7qlXud1yJh6E88No39MdcM_MI" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Josh Johanning"},"dateModified":"2022-07-26T09:29:59-05:00","datePublished":"2022-02-07T20:00:00-06:00","description":"Creating no-code GitHub Apps to install to an organization to replace having to create service accounts or a user PAT for authorization in GitHub Actions","headline":"Demystifying GitHub Apps: Using GitHub Apps to Replace Service Accounts","image":{"width":"100%","height":"100%","alt":"An example GitHub App","url":"https://josh-ops.com/github-apps.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://josh-ops.com/posts/github-apps/"},"url":"https://josh-ops.com/posts/github-apps/"}</script><title>Demystifying GitHub Apps: Using GitHub Apps to Replace Service Accounts | josh-ops</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="josh-ops"><meta name="application-name" content="josh-ops"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/sample/headshot.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">josh-ops</a></div><div class="site-subtitle font-italic">A DevOps Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-comment ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/joshjohanning" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/jjjettrain" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/joshua-johanning/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Demystifying GitHub Apps: Using GitHub Apps to Replace Service Accounts</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Demystifying GitHub Apps: Using GitHub Apps to Replace Service Accounts</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1644285600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 7, 2022 </em> </span> <span> Updated <em class="" data-ts="1658845799" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 26, 2022 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100% 100%'%3E%3C/svg%3E" data-src="/assets/screenshots/2022-02-07-github-apps/github-apps.png" class="preview-img bg" alt="An example GitHub App" width="100%" height="100%" data-proofer-ignore><figcaption class="pt-2 pb-2">An example GitHub App</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> Josh Johanning </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1788 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h2 id="overview"><span class="mr-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In GitHub Actions, the <a href="https://dev.to/github/the-githubtoken-in-github-actions-how-it-works-change-permissions-customizations-3cgp">GitHub Token</a> works very well and is convenient for automation tasks that require authentication, but its scope is limited. The GitHub Token is only going to allow us to access data within the repository (such as issues, code, packages), but what if you need to authenticate to another repository, or access organizational information such as teams or member lists? GitHub Token is not going to work for that. Your alternatives are:</p><ol><li>Use someone‚Äôs Personal Access Token (PAT) - but what happens if that person leaves? Or if you need to write back to an issue, for example, it‚Äôs going to look like it came from that user<li>Create a service account - but this is going to consume a license, and you still have to manage with vaulting and storing a long-lived PAT somewhere, and if that PAT gets exposed, you‚Äôre opening yourselves up to a huge security risk<li>GitHub Apps!</ol><p>In this post, I will go through the setup and usage of GitHub Apps in an Actions workflow with two scenarios: <a href="#scenario-1-using-a-github-app-to-grant-access-to-a-single-repository">Using a GitHub App to grant access to a single repository</a> and <a href="#scenario-2-using-a-github-app-as-a-rich-comment-bot">Using a GitHub App as a rich comment bot</a>.</p><p>And don‚Äôt worry - you don‚Äôt need any programming experience to create a GitHub App!</p><h2 id="github-apps"><span class="mr-2">GitHub Apps</span><a href="#github-apps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GitHub Apps are certainly preferred and recommended from GitHub. From <a href="https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps">GitHub‚Äôs documentation</a>, this fits our exact use case:</p><blockquote><p>GitHub Apps are the official recommended way to integrate with GitHub because they offer much more granular permissions to access data.</p><p>GitHub Apps are first-class actors within GitHub. A GitHub App acts on its own behalf, taking actions via the API directly using its own identity, which means you don‚Äôt need to maintain a bot or service account as a separate user.</p></blockquote><p>GitHub Apps also have a <a href="https://docs.github.com/en/rest/overview/resources-in-the-rest-api#rate-limiting">higher API rate limiting threshold</a> than requests from user accounts and GitHub Actions. <a href="https://github.blog/changelog/2020-07-27-increase-to-api-limits-in-github-enterprise-subscriptions/">Installed in an Enterprise</a>, GitHub Apps can have up to 15,000 requests per hour whereas the limit is 5,000 requests per hour coming from a user account and 1,000 requests per hour coming from GitHub Actions.</p><h3 id="caveats"><span class="mr-2">Caveats</span><a href="#caveats" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Each organization can only own up to <a href="https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-github-apps">100 GitHub Apps</a><li>You‚Äôll have to be an organization owner to create and install a GitHub app in an organization<li>Each installation access token is only valid for a <a href="https://docs.github.com/en/rest/reference/apps#create-an-installation-access-token-for-an-app">maximum of one hour</a></ul><h2 id="creating-a-github-app"><span class="mr-2">Creating a GitHub App</span><a href="#creating-a-github-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Creating a GitHub App is pretty straightforward! I‚Äôll defer to <a href="https://docs.github.com/en/developers/apps/building-github-apps/creating-a-github-app">GitHub‚Äôs documentation for the details</a>, but here‚Äôs a quick overview:</p><ol><li>Navigate to the organization‚Äôs settings page<li>Expand the ‚Äú<strong>Developer Settings</strong>‚Äù section at the bottom of the page and navigate to <strong>GitHub Apps</strong><li>Click ‚Äú<strong>New GitHub App</strong>‚Äù in the upper right-hand corner<li>Start filling in the details! The name and Homepage URL doesn‚Äôt matter much right now (but it does need a valid URL here)<li>What does matter is the ‚Äú<strong>Webhook URL</strong>‚Äù - if we want to <em>use</em> this GitHub App in the next section, we‚Äôll need to grab the installation ID. The easiest way to do that is to start a new channel at <a href="https://smee.io/">smee.io</a> and use the URL of the channel as the Webhook URL.<li>Grant it the <strong>repository permissions</strong>, <strong>organization permissions</strong>, <strong>user permissions</strong>, and what events to subscribe to - for the examples in this blog post, we‚Äôll grant <strong>read-only</strong> access to <code class="language-plaintext highlighter-rouge">repository / contents</code>, <strong>read &amp; write</strong> access to <code class="language-plaintext highlighter-rouge">repository / issues</code>, and <strong>read-only</strong> access to <code class="language-plaintext highlighter-rouge">organization / members</code> - if you change this after the it‚Äôs already been installed to an organization, you‚Äôll have review and re-approve the permission changes for the GitHub App<li>After creation, you should see a ‚Äúping‚Äù entry in your smee.io channel - this is a confirmation that the app was created<li>On the left-hand menu, you should now have a few options, one of those being ‚Äú<strong>Install App</strong>‚Äù - click it, and install the app to the organization<li>in your smee.io channel, you should have a new payload from the installation - expand the ‚Äúinstallation‚Äù property to find your ‚Äú<strong>installation ID</strong>‚Äù - this is the ID that you‚Äôll need to use in the next section<li>You‚Äôll also want to grab your <strong>App ID</strong> here (although note the App ID can also be found within GitHub)<li>Lastly, navigate back to your GitHub App‚Äôs administration page and <strong><a href="https://docs.github.com/en/developers/apps/building-github-apps/authenticating-with-github-apps#generating-a-private-key">generate a private key for the app</a></strong> - download the file and grab the contents of the certificate by opening it in VSCode or if you are on macOS: <code class="language-plaintext highlighter-rouge">cat approveops-bot.2022-02-07.private-key | pbcopy</code></ol><p><img data-src="/assets/screenshots/2022-02-07-github-apps/installation-id.png" alt="Installation and App ID from a payload in smee.io" width="600" class="shadow" data-proofer-ignore> <em>An example of an Installation ID and App ID from a payload in smee.io</em></p><p>üéâ We now have everything we need to use the app in GitHub Actions! ü•≥</p><h2 id="using-the-github-app-in-a-github-actions-workflow"><span class="mr-2">Using the GitHub App in a GitHub Actions workflow</span><a href="#using-the-github-app-in-a-github-actions-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There are a couple different actions to use such as:</p><ul><li><a href="https://github.com/marketplace/actions/github-app-installation-access-token-generator">navikt/github-app-token-generator</a><li><a href="https://github.com/marketplace/actions/workflow-application-token-action">peter-murray/workflow-application-token-action</a><li><a href="https://github.com/marketplace/actions/create-github-app-installation-token">jnwng/github-app-installation-token-action</a><li><a href="https://github.com/marketplace/actions/github-app-token">tibdex/github-app-token</a> (the one I am using below)</ul><p>I like <strong>navikt‚Äôs</strong>, <strong>jnwng‚Äôs</strong>, and <strong>tibdex‚Äôs</strong> versions because it doesn‚Äôt require the GitHub App to be installed on the repository that the action is running from whereas <strong>peter-murray‚Äôs</strong> does. That‚Äôs fine, but if the App must be installed on every repository, we‚Äôre not saving a ton with the app over the PAT (except that the GitHub App‚Äôs token has a built-in expiration). <strong>navikt‚Äôs</strong> version is a Docker-based action. I‚Äôm typically going to prefer a node-based action if given the preference since typically a Docker action takes a little bit longer to initiate and requires one additional component to be installed if using self-hosted runners. <strong>jnwng‚Äôs</strong> and <strong>tibdex‚Äôs</strong> actions are node-based actions, and both certainly work. I slightly prefer <strong>tibdex‚Äôs</strong> because you can either pass in an <code class="language-plaintext highlighter-rouge">installation_id</code> or not, depending on if the app is installed on the repository or not.</p><p>It‚Äôs really quite simple now that you have the installation ID, the app ID, and the private key. The only prerequisite is to create a secret on the repository (or <a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets#creating-encrypted-secrets-for-an-organization">organization</a>) with the private key‚Äôs contents. I named my secret <code class="language-plaintext highlighter-rouge">PRIVATE_KEY</code>.</p><h3 id="scenario-1-using-a-github-app-to-grant-access-to-a-single-repository"><span class="mr-2">Scenario 1: Using a GitHub App to grant access to a single repository</span><a href="#scenario-1-using-a-github-app-to-grant-access-to-a-single-repository" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A customer had a repository that nearly every Actions workflow was going to need to access at deploy-time. For the proof of concept, one of the admins on the team created a PAT and added it as an organizational secret. The problem is though that if the PAT is compromised, that PAT has access to <em>all the repositories in the organization</em>.</p><p>If there‚Äôs a centralized repository that every team needs to access, you can use the GitHub App to grant access to that repository and that repository alone. Note that you could also use <a href="https://docs.github.com/en/developers/overview/managing-deploy-keys">deploy keys</a> for this, but that requires you to use the SSH protocol when cloning. We‚Äôll continue as if the GitHub App is the preferred way to go so that you can understand the process.</p><p>Here‚Äôs the action code to generate and sign an installation access token for authenticating with GitHub:</p><div file=".github/workflows/test-permissions.yml" class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text=".github/workflows/test-permissions.yml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">tibdex/github-app-token@v1</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">get_installation_token</span>
        <span class="na">with</span><span class="pi">:</span> 
          <span class="na">app_id</span><span class="pi">:</span> <span class="m">170544</span>
          <span class="na">installation_id</span><span class="pi">:</span> <span class="m">23052920</span>
          <span class="na">private_key</span><span class="pi">:</span> <span class="s">${{ secrets.PRIVATE_KEY }}</span>

      <span class="c1"># clone using the `actions/checkout` step</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2.4.0</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">repository</span><span class="pi">:</span> <span class="s">my-org/my-repo</span>
          <span class="na">token</span><span class="pi">:</span> <span class="s">${{ steps.get_installation_token.outputs.token }}</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">my-repo</span>

        <span class="c1"># run the git clone ourselves</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Clone Repository</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span> 
          <span class="s">mkdir my-repo-2 &amp;&amp; cd my-repo-2</span>
          <span class="s">git clone https://x-access-token:${{ steps.get_installation_token.outputs.token }}@github.com/my-org/my-repo.git</span>
</pre></table></code></div></div><p>With the GitHub app installed on the <code class="language-plaintext highlighter-rouge">my-org/my-repo-2</code> repository and passing in the installation ID to the action, we have access to clone the repository even though it‚Äôs not the repository that the workflow is running from. We can also use the token generated here as a Bearer token for GitHub API requests, assuming it has the access.</p><p><img data-src="/assets/screenshots/2022-02-07-github-apps/clone-from-app.png" alt="Successful Git clone using a GitHub App" width="500" class="shadow" data-proofer-ignore> <em>Successful Git clone using a GitHup App</em></p><p>üéâ Repo cloned! ü•≥</p><h3 id="scenario-2-using-a-github-app-as-a-rich-comment-bot"><span class="mr-2">Scenario 2: Using a GitHub App as a rich comment bot</span><a href="#scenario-2-using-a-github-app-as-a-rich-comment-bot" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I‚Äôll often use the <a href="https://github.com/marketplace/actions/create-or-update-comment">peter-evans/create-or-update-comment</a> action to create a comment on a pull request or issue. Typically, I‚Äôll just use the $ for the <code class="language-plaintext highlighter-rouge">token</code> which comments as the <code class="language-plaintext highlighter-rouge">github-actions</code> bot, and it looks great!</p><p><img data-src="/assets/screenshots/2022-02-07-github-apps/github-actions-bot.png" alt="GitHub Actions Comment Bot" class="shadow" data-proofer-ignore> <em>GitHub Actions Comment Bot using GitHub Token from the Action run</em></p><p>However, if you look closely, you might notice something: since the GitHub Token only has access to the repository, it can‚Äôt create the proper <code class="language-plaintext highlighter-rouge">@team</code> mention in the comment. There is no hyperlink there. This might not be super important, but in my case the team was going to use their GitHub notifications to check if there were any issues that needed their attention, so this wasn‚Äôt going to work.</p><p>If we use a PAT and a secret on the repository, we get the <code class="language-plaintext highlighter-rouge">@team</code> mention, but it looks like it came from the user who created the PAT:</p><p><img data-src="/assets/screenshots/2022-02-07-github-apps/pat-bot.png" alt="GitHub Actions Comment Bot" class="shadow" data-proofer-ignore> <em>Issues comment from GitHub Actions using a PAT</em></p><p>Instead, we can use a GitHub App that with <strong>read-only</strong> permissions on <code class="language-plaintext highlighter-rouge">Organization / Members</code> and <strong>read &amp; write</strong> on <code class="language-plaintext highlighter-rouge">Repository / Issues</code> to create the comment and then we‚Äôll have the mention as well as not coming from a regular user:</p><p><img data-src="/assets/screenshots/2022-02-07-github-apps/app-bot.png" alt="GitHub Actions Comment Bot" class="shadow" data-proofer-ignore> <em>Issues comment from GitHub Actions using a GitHub App</em></p><p>Here‚Äôs the relevant action code:</p><div file=".github/workflows/approveops.yml" class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text=".github/workflows/approveops.yml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">tibdex/github-app-token@v1</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">get_installation_token</span>
        <span class="na">with</span><span class="pi">:</span> 
          <span class="na">app_id</span><span class="pi">:</span> <span class="m">170544</span>
          <span class="na">private_key</span><span class="pi">:</span> <span class="s">${{ secrets.PRIVATE_KEY }}</span>
          
      <span class="pi">-</span> <span class="na">if</span><span class="pi">:</span> <span class="s">${{ steps.check-approval.outputs.approved == 'false' }}</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Create completed comment</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">peter-evans/create-or-update-comment@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">token</span><span class="pi">:</span> <span class="s">${{ steps.get_installation_token.outputs.token }}</span>
          <span class="na">issue-number</span><span class="pi">:</span> <span class="s">${{ github.event.issue.number }}</span>
          <span class="na">body</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">Hey, @${{ github.event.comment.user.login }}!</span>
            <span class="s">:cry:  No one approved your run yet! Have someone from the @joshjohanning-org/approver-team run `/approve` and then try your command again</span>
            <span class="s">:no_entry_sign: :no_entry: Marking the workflow run as failed</span>
</pre></table></code></div></div><p>You‚Äôll notice that we didn‚Äôt have to pass in an installation ID this time to the action. This is because the GitHub App is installed on the repository, and the action can therefore lookup the installation ID dynamically to get the token.</p><p>üéâ Issue comment with team mentioning success! ü•≥</p><h2 id="summary"><span class="mr-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When I first learned about GitHub Apps, I was like, ‚ÄúThis is cool, but I‚Äôm not going to be writing an app and creating code just for authentication, that‚Äôs too much work, I‚Äôll just use a PAT.‚Äù However, as you just saw, we created a GitHub App and used it for authentication without tying it to any code.</p><p>In both scenarios, we use the <a href="https://github.com/marketplace/actions/github-app-token">tibdex/github-app-token</a> action and the installation access token that is an output parameter: <code class="language-plaintext highlighter-rouge">${{ steps.get_installation_token.outputs.token }}</code>. We use this token to make authenticated requests to the API or as the password in Git clones. Alternatively, <a href="https://docs.github.com/en/developers/apps/building-github-apps/authenticating-with-github-apps#authenticating-as-a-github-app">GitHub has sample Ruby code</a> for creating a and signing the JWT and retrieving an installation ID, but the action is so much simpler!</p><p>Check out my next post, <a href="/posts/github-approveops">ApproveOps: Approvals in IssueOps</a>, for more information on the action workflow I‚Äôm using in the second scenario.</p><p>Happy App-ing!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/github/'>GitHub</a>, <a href='/categories/actions/'>Actions</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/github/" class="post-tag no-text-decoration" >GitHub</a> <a href="/tags/github-actions/" class="post-tag no-text-decoration" >GitHub Actions</a> <a href="/tags/github-apps/" class="post-tag no-text-decoration" >GitHub Apps</a> <a href="/tags/github-issues/" class="post-tag no-text-decoration" >GitHub Issues</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Demystifying+GitHub+Apps%3A+Using+GitHub+Apps+to+Replace+Service+Accounts+-+josh-ops&url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fgithub-apps%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Demystifying+GitHub+Apps%3A+Using+GitHub+Apps+to+Replace+Service+Accounts+-+josh-ops&u=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fgithub-apps%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fgithub-apps%2F&text=Demystifying+GitHub+Apps%3A+Using+GitHub+Apps+to+Replace+Service+Accounts+-+josh-ops" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fgithub-apps%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/github-container-jobs/">Docker Container Jobs in GitHub Actions</a><li><a href="/posts/actions-runner-controller-without-cert-manager/">Configure actions-runner-controller without cert-manager</a><li><a href="/posts/azdo-commit-message-validator-and-pr-linker-github-action/">Azure DevOps Commit Message Validator and PR Linker GitHub Action</a><li><a href="/posts/azure-devops-migrate-work-items/">Azure DevOps: Migrate Work Items to New Organization / Project</a><li><a href="/posts/github-misc-scripts/">Miscellaneous GitHub API/GraphQL/CLI Automation Scripts</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github-actions/">GitHub Actions</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag" href="/tags/scripts/">Scripts</a> <a class="post-tag" href="/tags/work-items/">Work Items</a> <a class="post-tag" href="/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag" href="/tags/dependabot/">Dependabot</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/github-approveops/"><div class="card-body"> <em class="small" data-ts="1644330600" data-df="ll" > Feb 8, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ApproveOps: GitHub IssueOps with Approvals</h3><div class="text-muted small"><p> Overview This is follow-up to my previous post, Demystifying GitHub Apps: Using GitHub Apps to Replace Service Accounts, where I go over the basics of creating a GitHub App and accessing its insta...</p></div></div></a></div><div class="card"> <a href="/posts/gh-auth-login-in-actions/"><div class="card-body"> <em class="small" data-ts="1648486800" data-df="ll" > Mar 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to use gh auth login CLI Programmatically in GitHub Actions</h3><div class="text-muted small"><p> Overview Quick post here since I have to search for this every time I try to use the gh cli in GitHub Actions. In order to use the gh cli, you typically have to run gh auth login to authenticate. ...</p></div></div></a></div><div class="card"> <a href="/posts/actions-runner-controller-without-cert-manager/"><div class="card-body"> <em class="small" data-ts="1656450000" data-df="ll" > Jun 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configure actions-runner-controller without cert-manager</h3><div class="text-muted small"><p> Overview actions-runner-controller is a great way to set up self-scaling GitHub runners in a Kubernetes cluster. This allows teams to scale up their self-hosted runners as more jobs are queued thr...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/github-misc-scripts/" class="btn btn-outline-primary" prompt="Older"><p>Miscellaneous GitHub API/GraphQL/CLI Automation Scripts</p></a> <a href="/posts/github-approveops/" class="btn btn-outline-primary" prompt="Newer"><p>ApproveOps: GitHub IssueOps with Approvals</p></a></div><script src="https://utteranc.es/client.js" repo="joshjohanning/joshjohanning.github.io" issue-term="title" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> ¬© 2022 <a href="https://github.com/joshjohanning">Josh Johanning</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github-actions/">GitHub Actions</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag" href="/tags/scripts/">Scripts</a> <a class="post-tag" href="/tags/work-items/">Work Items</a> <a class="post-tag" href="/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag" href="/tags/dependabot/">Dependabot</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GE92ZJY22K"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GE92ZJY22K'); }); </script>
